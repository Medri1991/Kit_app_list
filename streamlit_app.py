import streamlit as st
import urllib.parse

st.set_page_config(page_title="Pantry Chef Pro", page_icon="ğŸ‘¨â€ğŸ³", layout="wide")

# --- 1. ×××’×¨ ××•×¦×¨×™× ×¢× ×§ (×›××• ×‘×¡×•×¤×¨) ---
# ×”×•×¡×¤×ª×™ ×¢×¨×š ×§×œ×•×¨×™ ××©×•×¢×¨ ×œ×›×œ 100 ×’×¨× ××• ×™×—×™×“×”
ingredients_db = {
    "×™×¨×§×•×ª ×•×¤×™×¨×•×ª ğŸ…": {
        "×¢×’×‘× ×™×•×ª": 18, "××œ×¤×¤×•× ×™×": 15, "×‘×¦×œ": 40, "×©×•×": 149, "×ª×¤×•×—×™ ××“××”": 77, "×’×–×¨": 41, 
        "×œ×™××•×Ÿ": 29, "×¤×˜×¨×•×–×™×œ×™×”": 36, "×—×¡×”": 15, "×ª×¤×•×—": 52, "×‘× × ×”": 89, "×’××‘×”": 31, "×§×™×©×•×": 17
    },
    "×§×¦×‘×™×” ×•×“×’×™× ğŸ¥©": {
        "×—×–×” ×¢×•×£": 165, "×‘×©×¨ ×˜×—×•×Ÿ": 250, "×¤×™×œ×” ×¡×œ××•×Ÿ": 208, "×˜×•× ×” ×‘×©××Ÿ": 190, "××× ×•×Ÿ": 128, 
        "× ×§× ×™×§×™×•×ª": 300, "×›×¨×¢×™ ×¢×•×£": 220, "×¤×™×œ×” ×‘×§×¨": 250
    },
    "××•×¦×¨×™ ×—×œ×‘ ×•×‘×™×¦×™× ğŸ§€": {
        "×‘×™×¦×™×": 155, "×—×œ×‘": 60, "×—×××”": 717, "×’×‘×™× ×” ×¦×”×•×‘×”": 350, "×©×× ×ª ××ª×•×§×”": 340, 
        "×¤×¨××–×Ÿ": 431, "×’×‘×™× ×” ×œ×‘× ×”": 98, "×™×•×’×•×¨×˜": 60, "×§×•×˜×’'": 98
    },
    "××–×•×•×” ×•×™×‘×© ğŸ¥«": {
        "××•×¨×–": 130, "×¤×¡×˜×”": 131, "×§××—": 364, "×¡×•×›×¨": 387, "×©××Ÿ ×–×™×ª": 884, "×¨×¡×§ ×¢×’×‘× ×™×•×ª": 82, 
        "×§×¨× ×§×•×§×•×¡": 230, "×’×¨×’×™×¨×™ ×—×•××•×¡": 164, "×¤×™×¨×•×¨×™ ×œ×—×": 395, "×¢×“×©×™×": 116, "×§×•×¡×§×•×¡": 112
    },
    "×ª×‘×œ×™× ×™× ×•×¨×˜×‘×™× ğŸ§‚": {
        "××œ×—": 0, "×¤×œ×¤×œ ×©×—×•×¨": 250, "×¤×¤×¨×™×§×”": 280, "×›××•×Ÿ": 370, "×§×˜×©×•×¤": 112, "××™×•× ×–": 680, "×—×¨×“×œ": 66, "×¡×™×œ××Ÿ": 280
    }
}

# --- 2. ×¡×¤×¨ ×”××ª×›×•× ×™× (×¢× ×¢×¨×š ×§×œ×•×¨×™ ×œ×× ×”) ---
recipes = [
    {"×©×": "×¤×¡×˜×” ×‘×•×œ×•× ×–", "×—×•×‘×”": ["×¤×¡×˜×”", "×‘×©×¨ ×˜×—×•×Ÿ", "×‘×¦×œ", "×¨×¡×§ ×¢×’×‘× ×™×•×ª"], "calories": 650, "image": "https://images.unsplash.com/photo-1546545229-ef2797686523?w=500"},
    {"×©×": "×¡×œ××•×Ÿ ×‘×ª× ×•×¨", "×—×•×‘×”": ["×¤×™×œ×” ×¡×œ××•×Ÿ", "×œ×™××•×Ÿ", "×©×•×", "×©××Ÿ ×–×™×ª"], "calories": 450, "image": "https://images.unsplash.com/photo-1519708227418-c8fd9a32b7a2?w=500"},
    {"×©×": "×©×§×©×•×§×” ×‘×™×ª×™×ª", "×—×•×‘×”": ["×‘×™×¦×™×", "×¢×’×‘× ×™×•×ª", "×‘×¦×œ", "×©××Ÿ ×–×™×ª"], "calories": 350, "image": "https://images.unsplash.com/photo-1590412200988-a436bb715048?w=500"},
    {"×©×": "×©× ×™×¦×œ ×•×¤×™×¨×”", "×—×•×‘×”": ["×—×–×” ×¢×•×£", "×¤×™×¨×•×¨×™ ×œ×—×", "×‘×™×¦×™×", "×ª×¤×•×—×™ ××“××”"], "calories": 720, "image": "https://images.unsplash.com/photo-1594759844614-3c2761b15ad3?w=500"},
    {"×©×": "××•×¨×– ×¢× ×¢×•×£ ×•×¡×™×œ××Ÿ", "×—×•×‘×”": ["××•×¨×–", "×—×–×” ×¢×•×£", "×¡×™×œ××Ÿ", "×‘×¦×œ"], "calories": 580, "image": "https://images.unsplash.com/photo-1600891963283-a4422e11e03c?w=500"},
    {"×©×": "×§×¦×™×¦×•×ª ×‘×¨×•×˜×‘", "×—×•×‘×”": ["×‘×©×¨ ×˜×—×•×Ÿ", "×‘×¦×œ", "×¨×¡×§ ×¢×’×‘× ×™×•×ª", "×¤×™×¨×•×¨×™ ×œ×—×"], "calories": 520, "image": "https://images.unsplash.com/photo-1529042410759-ad95287463ef?w=500"}
]

# × ×™×”×•×œ State
if 'weekly_plan' not in st.session_state: st.session_state.weekly_plan = []

# --- ×××©×§ ××©×ª××© ---
st.title("ğŸ‘¨â€ğŸ³ ×¢×•×–×¨ ×”××˜×‘×— ×”×—×›×")

tab1, tab2, tab3 = st.tabs(["ğŸ›’ ××” ×™×© ×œ×™?", "ğŸ“– ×¡×¤×¨ ××ª×›×•× ×™×", "ğŸ—“ï¸ ×ª×¤×¨×™×˜ ×•×¢×¨×›×™×"])

# --- ×˜××‘ 1: ××” ×™×© ×œ×š ×‘××˜×‘×—? ---
with tab1:
    st.info("""
    **××™×š ×–×” ×¢×•×‘×“?** ×¡××Ÿ ×›××Ÿ ××ª ×›×œ ×”××•×¦×¨×™× ×©×™×© ×œ×š ×›×¨×’×¢ ×‘×‘×™×ª.  
    ×”××¤×œ×™×§×¦×™×” ×ª× ×ª×— ××ª ×”××œ××™ ×©×œ×š ×•×ª×¦×™×’ ×‘×˜××‘ ×”×‘× **×¨×§** ××ª×›×•× ×™× ×©××ª×” ×™×›×•×œ ×œ×”×›×™×Ÿ ×›×¨×’×¢, ×‘×œ×™ ×©×ª×¦×˜×¨×š ×œ×œ×›×ª ×œ×¡×•×¤×¨!
    """)
    
    user_pantry = []
    cols = st.columns(3)
    for i, (cat, items) in enumerate(ingredients_db.items()):
        with cols[i % 3]:
            with st.expander(cat, expanded=True):
                for item in items:
                    if st.checkbox(item, key=f"pantry_{item}"):
                        user_pantry.append(item)
    user_pantry_set = set(user_pantry)

# --- ×˜××‘ 2: ×¡×¤×¨ ××ª×›×•× ×™× ---
with tab2:
    st.header("×× ×•×ª ×©× ×™×ª×Ÿ ×œ×”×›×™×Ÿ ×¢×›×©×™×•")
    
    # ×¡×™× ×•×Ÿ: ×¨×§ ×× ×•×ª ×©×™×© ×œ×”×Ÿ ××ª ×›×œ ××¦×¨×›×™ ×”×—×•×‘×”
    available_recipes = [r for r in recipes if all(ing in user_pantry_set for ing in r["×—×•×‘×”"])]
    
    if not available_recipes:
        st.warning("×œ× × ××¦××• ××ª×›×•× ×™× ×©××ª××™××™× ×‘×“×™×•×§ ×œ××” ×©×™×© ×œ×š. × ×¡×” ×œ×¡××Ÿ ×¢×•×“ ××•×¦×¨×™× ×‘×˜××‘ ×”×¨××©×•×Ÿ!")
    else:
        grid = st.columns(2)
        for idx, r in enumerate(available_recipes):
            with grid[idx % 2]:
                with st.container(border=True):
                    st.image(r['image'], use_container_width=True)
                    st.subheader(r['×©×'])
                    st.write(f"**××¦×¨×›×™×:** {', '.join(r['×—×•×‘×”'])}")
                    if st.button(f"×”×•×¡×£ ×œ×ª×¤×¨×™×˜ ×”×©×‘×•×¢×™", key=f"add_{r['×©×']}"):
                        st.session_state.weekly_plan.append(r)
                        st.toast(f"{r['×©×']} × ×•×¡×£!")

# --- ×˜××‘ 3: ×ª×¤×¨×™×˜ ×•×¢×¨×›×™× ---
with tab3:
    st.header("×”×ª×¤×¨×™×˜ ×©×œ×š ×•×¢×¨×š ×§×œ×•×¨×™")
    
    if st.session_state.weekly_plan:
        total_cal = 0
        for r in st.session_state.weekly_plan:
            with st.expander(f"ğŸ´ {r['×©×']} - {r['calories']} ×§×œ×•×¨×™×•×ª"):
                st.write("**×¤×™×¨×•×˜ ×§×œ×•×¨×™ ×œ×¤×™ ×¨×›×™×‘ (×œ-100 ×’×¨×/×™×—'):**")
                for ing in r["×—×•×‘×”"]:
                    cal = ingredients_db.get(cat, {}).get(ing, "×œ× ×™×“×•×¢")
                    # ×—×™×¤×•×© ×”×¢×¨×š ×”×§×œ×•×¨×™ ×‘×××’×¨
                    found_cal = 0
                    for c_cat in ingredients_db:
                        if ing in ingredients_db[c_cat]:
                            found_cal = ingredients_db[c_cat][ing]
                    st.write(f"- {ing}: {found_cal} ×§×œ×•×¨×™×•×ª")
                total_cal += r['calories']
        
        st.divider()
        st.metric("×¡×”\"×› ×§×œ×•×¨×™×•×ª ×œ×ª×¤×¨×™×˜", f"{total_cal} ×§×§\"×œ")
        
        if st.button("× ×§×” ×ª×¤×¨×™×˜"):
            st.session_state.weekly_plan = []
            st.rerun()
    else:
        st.info("×‘×—×¨ ××ª×›×•× ×™× ×‘×˜××‘ ×”×§×•×“× ×›×“×™ ×œ×¨××•×ª ×›××Ÿ ×¡×™×›×•×.")
